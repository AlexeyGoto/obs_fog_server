{% extends "base.html" %}

{% block title %}PC Details - OBS Fog Server{% endblock %}

{% block content %}
<div x-data="pcDetail()" x-init="loadPC()">
    <!-- Back link -->
    <a href="/dashboard" class="inline-flex items-center text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 mb-6">
        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
        </svg>
        Back to Dashboard
    </a>

    <!-- Loading State -->
    <div x-show="loading" class="space-y-6">
        <div class="card p-6">
            <div class="h-8 bg-gray-200 dark:bg-gray-700 rounded w-1/3 skeleton mb-4"></div>
            <div class="h-4 bg-gray-200 dark:bg-gray-700 rounded w-2/3 skeleton"></div>
        </div>
    </div>

    <!-- PC Details -->
    <div x-show="!loading && pc">
        <!-- Header -->
        <div class="flex flex-col md:flex-row md:items-start md:justify-between mb-8">
            <div class="flex items-center space-x-4">
                <div class="w-16 h-16 rounded-2xl bg-gradient-to-br from-primary-500 to-accent-500 flex items-center justify-center shadow-lg shadow-primary-500/25">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                    </svg>
                </div>
                <div>
                    <h1 class="text-3xl font-bold text-gray-900 dark:text-white" x-text="pc.name"></h1>
                    <div class="flex items-center space-x-3 mt-2">
                        <span class="badge" :class="pc.is_active ? 'badge-success' : 'badge-warning'" x-text="pc.is_active ? 'Active' : 'Inactive'"></span>
                        <span x-show="pc.is_live" class="badge badge-danger flex items-center">
                            <span class="live-indicator mr-2" style="transform: scale(0.6);"></span>
                            LIVE
                        </span>
                    </div>
                </div>
            </div>
            <div class="flex items-center space-x-3 mt-4 md:mt-0">
                <a :href="'/api/v1/downloads/obs-profile/' + pc.id" class="btn btn-secondary">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                    </svg>
                    OBS Profile
                </a>
                <a :href="'/api/v1/downloads/obs-installer/' + pc.id" class="btn btn-primary">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                    Setup Script
                </a>
            </div>
        </div>

        <!-- Stream Key Card -->
        <div class="card p-6 mb-6">
            <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Stream Configuration</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mb-2">RTMP URL</p>
                    <div class="flex items-center space-x-2">
                        <code class="flex-1 bg-gray-100 dark:bg-gray-700 px-4 py-3 rounded-lg text-sm font-mono">rtmp://your-server.com/live</code>
                        <button @click="copyToClipboard('rtmp://your-server.com/live')" class="btn btn-ghost">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                            </svg>
                        </button>
                    </div>
                </div>
                <div>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mb-2">Stream Key</p>
                    <div class="flex items-center space-x-2">
                        <code class="flex-1 bg-gray-100 dark:bg-gray-700 px-4 py-3 rounded-lg text-sm font-mono truncate" x-text="pc.stream_key"></code>
                        <button @click="copyToClipboard(pc.stream_key)" class="btn btn-ghost">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
            <div class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700">
                <button @click="regenerateKey()" class="text-sm text-red-600 hover:text-red-700 font-medium">
                    Regenerate Stream Key
                </button>
            </div>
        </div>

        <!-- Sessions -->
        <div class="card p-6">
            <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Stream Sessions</h2>
            <div x-show="sessions.length === 0" class="text-center py-12 text-gray-500 dark:text-gray-400">
                <svg class="w-12 h-12 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                </svg>
                <p>No stream sessions yet</p>
            </div>
            <div x-show="sessions.length > 0" class="space-y-4">
                <template x-for="session in sessions" :key="session.id">
                    <div class="p-4 bg-gray-50 dark:bg-gray-700/50 rounded-xl flex items-center justify-between">
                        <div>
                            <div class="flex items-center space-x-2">
                                <span class="badge" :class="session.ended_at ? 'badge-secondary' : 'badge-success'" x-text="session.ended_at ? 'Ended' : 'Live'"></span>
                                <span class="text-sm text-gray-500" x-text="formatDate(session.started_at)"></span>
                            </div>
                            <p class="text-sm text-gray-600 dark:text-gray-400 mt-1" x-text="session.duration ? formatDuration(session.duration) : 'In progress'"></p>
                        </div>
                    </div>
                </template>
            </div>
        </div>
    </div>
</div>

<script>
function pcDetail() {
    return {
        pc: null,
        sessions: [],
        loading: true,
        pcId: {{ pc_id }},

        async loadPC() {
            try {
                const response = await fetch(`/api/v1/pcs/${this.pcId}`);
                if (response.ok) {
                    this.pc = await response.json();
                    await this.loadSessions();
                }
            } catch (err) {
                console.error('Failed to load PC:', err);
            } finally {
                this.loading = false;
            }
        },

        async loadSessions() {
            try {
                const response = await fetch(`/api/v1/pcs/${this.pcId}/sessions`);
                if (response.ok) {
                    const data = await response.json();
                    this.sessions = data.items || [];
                }
            } catch (err) {
                console.error('Failed to load sessions:', err);
            }
        },

        async regenerateKey() {
            if (!confirm('Regenerate stream key? Current key will stop working immediately.')) return;
            try {
                const response = await fetch(`/api/v1/pcs/${this.pcId}/regenerate-key`, { method: 'POST' });
                if (response.ok) {
                    await this.loadPC();
                    notify('Stream key regenerated!', 'success');
                }
            } catch (err) {
                notify('Failed to regenerate key', 'error');
            }
        },

        copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                notify('Copied!', 'success');
            });
        },

        formatDate(dateStr) {
            return new Date(dateStr).toLocaleString();
        },

        formatDuration(seconds) {
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = seconds % 60;
            if (h > 0) return `${h}h ${m}m ${s}s`;
            if (m > 0) return `${m}m ${s}s`;
            return `${s}s`;
        }
    };
}
</script>
{% endblock %}
