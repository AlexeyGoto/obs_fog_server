# Verbose logging helps when diagnosing RTMP pipeline issues.
error_log  /var/log/nginx/error.log info;
pid        /var/run/nginx.pid;

worker_processes  auto;

events {
    worker_connections  1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    sendfile        on;
    tcp_nopush      on;
    tcp_nodelay     on;
    keepalive_timeout  65;

    server {
        listen      80;
        server_name _;

        # Health-check endpoint
        location = /healthz {
            access_log off;
            add_header Content-Type text/plain;
            return 200 "ok\n";
        }

        # HLS output
        location /hls/ {
            alias /var/hls/;
            types {
                application/vnd.apple.mpegurl m3u8;
                video/mp2t                    ts;
            }
            add_header Cache-Control "no-cache" always;
            add_header Access-Control-Allow-Origin "*" always;
            add_header Access-Control-Allow-Headers "*" always;
            add_header Access-Control-Allow-Methods "GET, HEAD, OPTIONS" always;
            expires -1;
        }

        # Static index (basic auth injected via include)
        location / {
            include /etc/nginx/conf.d/location_auth.conf;

            root  /usr/share/nginx/html;
            index index.html;
            try_files $uri $uri/ /index.html;
        }
    }
}

# RTMP ingestion
rtmp {
    # Log RTMP sessions (publish/stop/connect)
    access_log /var/log/nginx/rtmp_access.log;

    server {
        listen 1935;
        chunk_size 4096;
        ping 30s;
        ping_timeout 10s;

        application live {
            live on;

            # Publish to HLS for playback
            hls on;
            hls_path /var/hls;
            hls_fragment 2s;            # matches OBS keyint=2s
            hls_playlist_length 20s;    # ~10 segments
            hls_cleanup on;

            # Recorder hooks
            exec_publish      /usr/local/bin/start_recorder.sh $app $name;
            exec_publish_done /usr/local/bin/stop_recorder_and_finalize.sh $app $name;
        }
    }
}
