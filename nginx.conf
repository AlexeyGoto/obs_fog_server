# Пробрасываем env в воркеры (для exec-скрипта)
env BOT_TOKEN;
env CHAT_ID;
env BASE_URL;

# Модуль RTMP (ubuntu-путь)
load_module /usr/lib/nginx/modules/ngx_rtmp_module.so;

user  www-data;
worker_processes auto;
pid /run/nginx.pid;

events { worker_connections 1024; }

http {
    server {
        listen 80 default_server;
        server_name _;

        # Basic auth по умолчанию (кроме /videos и /healthz)
        auth_basic           "Protected";
        auth_basic_user_file /etc/nginx/htpasswd;

        # health-check без авторизации
        location = /healthz {
            auth_basic off;
            default_type text/plain;
            return 200 "ok\n";
        }

        # Главная и статика
        location / {
            root  /usr/share/nginx/html;
            index index.html;
            try_files $uri /index.html;
        }

        # HLS: манифесты и сегменты — с авторизацией
        location /hls/ {
            alias /tmp/hls/;
            types {
                application/vnd.apple.mpegurl m3u8;
                video/mp2t ts;
            }
            add_header Cache-Control no-cache;
            auth_basic           "Protected";
            auth_basic_user_file /etc/nginx/htpasswd;
        }

        # Готовые видео для Telegram — без авторизации
        location /videos/ {
            alias /var/videos/;
            autoindex off;
            auth_basic off;
            add_header Cache-Control no-cache;
        }
    }
}

rtmp {
    server {
        listen 1935;
        chunk_size 4096;

        application live {
            live on;
            max_connections 50;

            # HLS ~ 5 минут
            hls on;
            hls_path /tmp/hls;
            hls_fragment 5s;
            hls_playlist_length 300s;
            hls_cleanup on;
            hls_nested on;          # => /hls/<name>/index.m3u8

            # После остановки стрима — сборка и отправка
            exec_publish_done /app/on_stream_done.sh $name;
        }
    }
}
