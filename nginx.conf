# Разрешаем передавать выбранные переменные окружения в worker-процессы
# (чтобы скрипт exec_publish_done видел их)
env BOT_TOKEN;
env CHAT_ID;
env BASE_URL;

# Модуль RTMP из пакета Ubuntu
load_module /usr/lib/nginx/modules/ngx_rtmp_module.so;

user  www-data;
worker_processes auto;
pid /run/nginx.pid;

events { worker_connections 1024; }

http {
    server {
        listen 80;

        # Базовая авторизация для интерфейса и HLS
        auth_basic           "Protected";
        auth_basic_user_file /etc/nginx/htpasswd;

        # Главная (веб-интерфейс)
        location = / {
            root  /usr/share/nginx/html;
            index index.html;
        }

        # HLS: плейлисты и сегменты (с авторизацией)
        location /hls/ {
            alias /tmp/hls/;
            types {
                application/vnd.apple.mpegurl m3u8;
                video/mp2t ts;
            }
            add_header Cache-Control no-cache;
            auth_basic           "Protected";
            auth_basic_user_file /etc/nginx/htpasswd;
        }

        # Готовые видео для Telegram (без авторизации!)
        location /videos/ {
            alias /var/videos/;
            autoindex off;
            auth_basic off;
            # Чтобы Telegram мог скачивать без редиректов и кэшей
            add_header Cache-Control no-cache;
        }
    }
}

rtmp {
    server {
        listen 1935;     # входящий RTMP
        chunk_size 4096;

        application live {
            live on;
            max_connections 50;

            # HLS (окно ~5 минут)
            hls on;
            hls_path /tmp/hls;
            hls_fragment 5s;
            hls_playlist_length 300s; # 5 минут
            hls_cleanup on;
            hls_nested on;            # подкаталоги per-stream

            # При завершении стрима склеиваем и отправляем видео
            exec_publish_done /app/on_stream_done.sh $name;
        }
    }
}

