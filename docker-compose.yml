services:
  nginx:
    build:
      context: ./nginx
    restart: unless-stopped
    ports:
      - "1935:1935"   # RTMP ingest (OBS)
      - "8080:8080"   # HTTP gateway (web + HLS)
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./data/hls:/data/hls
    depends_on:
      - api

  api:
    build:
      context: ./api
    restart: unless-stopped
    env_file:
      - .env
    environment:
      HLS_BASE_URL: ${HLS_BASE_URL:-http://nginx:8080/hls}
    volumes:
      - ./data/db:/data/db
      - ./data/videos:/data/videos
    # ВАЖНО: api НЕ зависит от nginx (убрали цикл)

  worker:
    build:
      context: ./worker
    restart: unless-stopped
    env_file:
      - .env
    environment:
      HLS_BASE_URL: ${HLS_BASE_URL:-http://nginx:8080/hls}
    volumes:
      - ./data/db:/data/db
      - ./data/videos:/data/videos
    depends_on:
      - api
      - nginx

  bot:
    build:
      context: ./bot
    restart: unless-stopped
    env_file:
      - .env
    depends_on:
      - api
