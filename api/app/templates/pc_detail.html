{% extends 'base.html' %}
{% block content %}
<div class="flex items-start justify-between gap-4">
  <div>
    <div class="text-2xl font-semibold">{{ pc.name }}</div>
    <div class="text-sm text-slate-400 mt-1">ID {{ pc.id }} • создан {{ pc.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</div>
  </div>
  <div class="flex gap-2">
    <form method="post" action="/pc/{{ pc.id }}/regen">
      <button class="px-4 py-2 rounded-xl bg-slate-800 hover:bg-slate-700">Сменить Stream Key</button>
    </form>
    <a href="/" class="px-4 py-2 rounded-xl bg-slate-800 hover:bg-slate-700">Назад</a>
  </div>
</div>

<div class="mt-6 grid grid-cols-1 lg:grid-cols-2 gap-4">
  <div class="bg-slate-900/50 border border-slate-800 rounded-2xl p-6">
    <div class="text-lg font-semibold">Настройки OBS</div>
    <div class="mt-3 text-sm text-slate-300">
      <div class="text-slate-400">Server</div>
      <div class="font-mono break-all">{{ rtmp_url }}</div>
      <div class="mt-3 text-slate-400">Stream Key</div>
      <div class="font-mono break-all">{{ pc.stream_key }}</div>
    </div>

    <div class="mt-5 text-sm text-slate-300">
      <div class="text-slate-400">HLS (для просмотра)</div>
      <div class="font-mono break-all">{{ hls_url }}</div>
    </div>

    <div class="mt-6 text-xs text-slate-500">
      Совет: если OBS пишет «не удалось подключиться», проверь, что ключ совпадает и что порт 1935 открыт.
    </div>
  </div>

  <div class="bg-slate-900/50 border border-slate-800 rounded-2xl p-6">
    <div class="flex items-center justify-between">
      <div class="text-lg font-semibold">Live просмотр</div>
      <a class="text-sm text-slate-300 hover:underline" href="{{ hls_url }}" target="_blank">Открыть m3u8</a>
    </div>

    <div class="mt-3">
      <video id="player" controls class="w-full rounded-xl bg-black" playsinline></video>
    </div>

    <div class="mt-3 text-xs text-slate-500">
      Плеер работает, если есть активный стрим и генерируются HLS сегменты.
    </div>
  </div>
</div>

<div class="mt-6 bg-slate-900/50 border border-slate-800 rounded-2xl p-6">
  <div class="text-lg font-semibold">История сессий</div>
  <div class="mt-3 overflow-x-auto">
    <table class="w-full text-sm">
      <thead>
        <tr class="text-left text-slate-400">
          <th class="py-2">Начало</th>
          <th class="py-2">Конец</th>
          <th class="py-2">Статус</th>
          <th class="py-2">Сообщение</th>
        </tr>
      </thead>
      <tbody>
        {% for s in sessions %}
          <tr class="border-t border-slate-800">
            <td class="py-2 font-mono">{{ s.started_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
            <td class="py-2 font-mono">{% if s.ended_at %}{{ s.ended_at.strftime('%Y-%m-%d %H:%M:%S') }}{% else %}-{% endif %}</td>
            <td class="py-2"><span class="px-2 py-1 rounded-lg bg-slate-800">{{ s.status }}</span></td>
            <td class="py-2 text-slate-300">{{ s.message if s.message else '' }}</td>
          </tr>
        {% else %}
          <tr>
            <td class="py-4 text-slate-400" colspan="4">Сессий пока нет.</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<script>
  (function(){
    const video = document.getElementById('player');
    const url = {{ hls_url|tojson }};
    if (Hls.isSupported()) {
      const hls = new Hls({
        maxBufferLength: 30,
        liveSyncDurationCount: 3,
      });
      hls.loadSource(url);
      hls.attachMedia(video);
      hls.on(Hls.Events.ERROR, function(_, data) {
        console.log('HLS error', data);
      });
    } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
      video.src = url;
    }
  })();
</script>
{% endblock %}
