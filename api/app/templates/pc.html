{% extends "base.html" %}
{% block content %}
<div class="row" style="justify-content:space-between; align-items:flex-start;">
  <div>
    <h1 style="margin:0 0 6px 0;">ПК #{{ pc.id }} — {{ pc.name }}</h1>
    {% if pc.is_live %}
      <span class="pill ok">LIVE</span>
    {% else %}
      <span class="pill off">OFF</span>
    {% endif %}
    <div class="muted small" style="margin-top:8px;">stream_key: <code>{{ pc.stream_key }}</code></div>
  </div>
  <div>
    <a href="/" class="muted">← обратно к списку</a>
  </div>
</div>

<div class="grid" style="margin-top:16px;">
  <div class="card">
    <h3>Настройки OBS</h3>
    <div class="row" style="align-items:flex-start;">
      <div style="flex:1;">
        <div class="muted small">Server (Custom)</div>
        <code>{{ rtmp_url }}</code>
      </div>
      <div style="flex:1;">
        <div class="muted small">Stream Key</div>
        <code>{{ pc.stream_key }}</code>
      </div>
    </div>
    <p class="muted small" style="margin-top:12px;">
      Рекомендация: Keyframe interval 2s (или Auto). Сегменты без перекодирования.
    </p>
  </div>

  <div class="card">
    <h3>Live просмотр</h3>
    <div class="muted small" style="margin-bottom:10px;">HLS URL: <code>{{ hls_url }}</code></div>
    <video id="v" controls autoplay muted style="width:100%; background:#000; border-radius:12px;"></video>
    <p class="muted small" style="margin-top:10px;">
      Если поток OFF — плеер ничего не покажет (это нормально).
    </p>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.18"></script>
<script>
  (function(){
    const url = {{ hls_url|tojson }};
    const video = document.getElementById('v');
    if (video.canPlayType('application/vnd.apple.mpegurl')) {
      video.src = url;
      return;
    }
    if (window.Hls && Hls.isSupported()) {
      const hls = new Hls({
        liveSyncDurationCount: 3,
        maxLiveSyncPlaybackRate: 1.0
      });
      hls.loadSource(url);
      hls.attachMedia(video);
      hls.on(Hls.Events.ERROR, function(ev, data){
        console.log('HLS error', data);
      });
    } else {
      console.log('HLS not supported');
    }
  })();
</script>

{% endblock %}
